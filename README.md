
УМНЫЙ ЭЛЕКТРОЧАЙНИК НА ATTINY44A
═══════════════════════════════════════
КРАТКО
------
Назначение: 
  Измерять температуру воды (NTC термистор), управлять нагревом через 
  реле 5V с коммутацией 220V, индицировать состояние RGB LED и 5 LED 
  индикаторами, подавать звуковые сигналы через буззер.
Платформа: 
  ATtiny44A (DIP-14), тактовая частота 8 MHz (внутренний RC-генератор)
Среды разработки:
  - Microchip Studio (с AVR-GCC)
  - Arduino IDE (с поддержкой ATtiny)
═══════════════════════════════════════════════════════════════════════
БЫСТРЫЕ ФАКТЫ (ВХОДЫ / ВЫХОДЫ)
═══════════════════════════════════════════════════════════════════════
ВХОДЫ:
  • KEY1 (кнопка 1)  → PA2 (pin 11, через мост 3-4)
  • KEY2 (кнопка 2)  → PB0 (pin 2, через мост 1-2)
  • NTC термистор    → PA1 (ADC1, pin 12)
СИСТЕМНЫЕ ПИНЫ:
  • PA0 (pin 13)     → RESET (для ISP программирования)
  • PB3 (pin 4)      → EXTRA_PIN (резерв, подтянуть к VCC через 10кОм)
ВЫХОДЫ:
  • RELAY            → PA4 (pin 9, через 2N7002 MOSFET)
  • RGB LED красный  → PB2 (pin 5, PWM OCR0A)
  • RGB LED зелёный  → PA7 (pin 6, PWM OCR0B)
  • RGB LED синий    → PA6 (pin 7, PWM OCR1A)
  • LED индикаторы   → Мостовая схема (A_1_2=PB0, A_3_4=PA2, C_1_3=PA3, C_2_4=PB1)
  • BUZZER           → PA5 (pin 8, через MMBT2222A NPN, ПРЯМАЯ ЛОГИКА)
ПАМЯТЬ:
  • EEPROM адрес 0x00: последний выбранный режим температуры (0-4)
  • EEPROM адрес 0x01: последний режим подсветки/эффектов (1-8)
═══════════════════════════════════════════════════════════════════════
РЕЖИМЫ РАБОТЫ
═══════════════════════════════════════════════════════════════════════
ПРЕДУСТАНОВЛЕННЫЕ ТЕМПЕРАТУРЫ (°C):
  Режим 1: 40°C  → LED1 ●     → 🔵 Синий (оттенок 180)
  Режим 2: 50°C  → LED2 ●     → 🟢 Зелёный (оттенок 96)
  Режим 3: 60°C  → LED3 ●     → 🟡 Желто-зелёный (оттенок 64)
  Режим 4: 80°C  → LED4 ●     → 🟠 Желтый (оттенок 32)
  Режим 5: 90°C  → LED5 ●●    → 🔴 Оранжево-красный (оттенок 16)

СПЕЦИАЛЬНЫЕ РЕЖИМЫ КИПЯЧЕНИЯ:
  • Полное кипячение (по умолчанию): ~16 секунд при 95°C
  • Частичное кипячение (partial_boil): ¼ времени (~4 секунды)
    Активация: удержание BTN1 в режиме BOILING

ЭФФЕКТЫ ПОДСВЕТКИ RGB (8 режимов):
  Эффекты 1-4:   Плавная смена цветов (hue sweep)
    Скорости: 255, 128, 64, 32 мс
  Эффекты 5-8:   Температурная пульсация (цвет по текущей температуре)
    Скорости: 255, 128, 64, 32 мс
  
  Активация: Длительное удержание BTN2 (12 сек) в режиме OFF
  Переключение: Короткое удержание BTN2 (3 сек) в режиме эффектов
  Автоотключение: через 20 минут бездействия
  Сохранение в EEPROM: автоматически при выходе из режима эффектов
═══════════════════════════════════════════════════════════════════════
БЕЗОПАСНОСТЬ И КОНТРОЛЬ
═══════════════════════════════════════════════════════════════════════
WATCHDOG TIMER:
  • WDT включён: WDTO_8S (таймаут 8 секунд)
  • Сброс в главном цикле каждые 5мс: wdt_reset()
  • Автоматическая перезагрузка при зависании

ЗАЩИТНЫЕ ПОРОГИ (в сотых °C):
  • TEMP_MAX:           10300 (103°C)    → Аварийное отключение
  • TEMP_MIN:           715 (7.15°C)     → Обрыв датчика/пустой чайник
  • TEMP_BOIL:          9500 (95°C)      → Начало отсчёта кипячения

ТАЙМАУТЫ БЕЗОПАСНОСТИ (миллисекунды):
  • TIME_TEMP_STUCK:    262144 мс (~4.4 мин)
    ↳ Если температура не растёт → аварийное отключение
  • TIME_MAX_HEATING:   2097152 мс (~35 мин)
    ↳ Максимальное время нагрева → аварийное отключение
  • TIME_EFFECT_MAX:    1200000 мс (20 мин)
    ↳ Автоматическое отключение режима просмотра эффектов

КОНТРОЛЬ СКОРОСТИ НАГРЕВА:
  • Адаптивная корректировка temp_compensation для точного выключения
  • Расчёт скорости нагрева (rate) для прогнозирования времени кипения
  • Защита от сухого кипячения: скорость >5000 (50°C/сек) → ERROR
  • Динамическая формула времени кипения:
    boil_time = 19082305 / rate + 5375 (в миллисекундах)
  • Для partial_boil: boil_time делится на 4
═══════════════════════════════════════════════════════════════════════
ИНДИКАЦИЯ И ЗВУК
═══════════════════════════════════════════════════════════════════════
RGB LED (ОБЩИЙ АНОД, ИНВЕРСНАЯ ЛОГИКА PWM):
  • Аппаратный PWM: Timer0 (OCR0A, OCR0B), Timer1 (OCR1A)
  • Инверсия в коде: OCR0A = 255 - r (255 → LED выключен, 0 → макс яркость)
  • HSV→RGB преобразование для плавных эффектов
  • Температурная индикация: от синего (40°C) до красного (95°C)
    Формула: hue = 180 - ((temp - 4000) * 164) / 5500

LED ИНДИКАТОРЫ (МОСТОВАЯ СХЕМА):
  • 5 LED управляются через 2 моста (делители напряжения)
  • Матричное мультиплексирование для отображения режимов
  • Резисторы по 470Ω в каждом мосту
  • LED5: зажигает LED3 + LED4 одновременно (через оба катода)

BUZZER (ПАССИВНЫЙ, ПРЯМАЯ ЛОГИКА):
  ⚠️ ВАЖНО: Управление через NPN транзистор MMBT2222A/SS8050
  • HIGH на PA5 → транзистор открыт → buzzer ВКЛЮЧЕН
  • LOW на PA5 → транзистор закрыт → buzzer ВЫКЛЮЧЕН
  
  Звуковые сигналы:
  1. Подтверждение нажатия кнопки: 30 мс писк
  2. Режим ALARMING (достижение цели): 30-секундный сигнал
     0-10 сек → звук, 10-20 сек → тишина, 20-30 сек → звук
  3. Режим ERROR (авария): тревожный прерывистый сигнал 250 мс
     (синхронно с миганием красного LED)
═══════════════════════════════════════════════════════════════════════
УПРАВЛЕНИЕ (UX)
═══════════════════════════════════════════════════════════════════════
КНОПКА BTN1 (KEY1, PA2, pin 11):
  Короткое нажатие:
    • В режиме OFF: запуск кипячения (BOILING)
    • В режиме SELECTING: отмена выбора, возврат в OFF
    • В режиме HEATING/BOILING: остановка нагрева, возврат в OFF
    • В режиме ALARMING/ERROR: возврат в OFF
  
  Длительное удержание (>3 сек):
    • В режиме BOILING: переключение partial_boil (вкл/выкл)
      Индикация: желтый цвет (вкл) или красный (выкл) на 1 секунду

КНОПКА BTN2 (KEY2, PB0, pin 2):
  Короткое нажатие:
    • В режиме OFF: вход в режим выбора (SELECTING)
    • В режиме SELECTING: переключение пресета (1→2→3→4→5→1)
    • В режиме эффектов: выход из режима эффектов
  
  Удержание 3 секунды:
    • В режиме SELECTING: сохранение пресета в EEPROM
      (LED мигнёт: выключится на 250мс, затем снова зажжётся)
    • В режиме эффектов: переключение эффекта (1→2→...→8→1)
  
  Очень длительное удержание (12 секунд):
    • В режиме OFF: активация режима эффектов (эффект 1)

ТАЙМЕРЫ ИНТЕРФЕЙСА:
  • TIME_DEBOUNCE = 200 мс (антидребезг кнопок)
  • TIME_HOLD_SHORT = 3000 мс (короткое удержание)
  • TIME_HOLD_LONG = 12000 мс (длительное удержание)
  • TIME_SELECT = 12000 мс (автостарт после выбора пресета)

АВТОСТАРТ НАГРЕВА:
  • После выбора режима: 12 секунд на подтверждение
  • Если temp_now < temp_target - 350 (3.5°C) → автоматический старт HEATING
  • Иначе (вода уже горячая) → возврат в OFF
═══════════════════════════════════════════════════════════════════════
ЧТЕНИЕ КНОПОК В КОДЕ
═══════════════════════════════════════════════════════════════════════
МОСТОВАЯ СХЕМА С ЦИФРОВЫМИ ВХОДАМИ:
  В коде main.c (функция read_button):
  
  if (!(PINA & _BV(A_3_4))) btn = 1;      // PA2 → BTN1 (KEY1)
  else if (!(PINB & _BV(A_1_2))) btn = 2; // PB0 → BTN2 (KEY2)

ПРИНЦИП:
  • В покое: пины подтянуты через делитель 470Ω-470Ω к HIGH
  • При нажатии: кнопка замыкает на GND → пин читает LOW
  • МК определяет LOW как нажатие кнопки
  • Антидребезг: 200 мс после первого изменения состояния
  • Уровни удержания: 0 (не нажата), 1 (>200мс), 2 (>3сек), 3 (>12сек)
═══════════════════════════════════════════════════════════════════════
СОСТОЯНИЯ СИСТЕМЫ (State)
═══════════════════════════════════════════════════════════════════════
OFF:
  • Реле выключено
  • RGB LED выключен
  • LED индикаторы выключены
  • preset_idx сброшен в 0
  • partial_boil сброшен в false

SELECTING:
  • Реле выключено
  • RGB LED показывает цвет выбранного пресета (полная яркость)
  • Горит соответствующий LED индикатор (1-5)
  • preset_idx загружается из EEPROM при входе в режим
  • Таймер автостарта: 12 секунд

HEATING:
  • Реле включено (нагрев)
  • RGB LED пульсирует с цветом текущей температуры (0-255)
  • LED индикаторы выключены
  • Контроль скорости нагрева и расчёт temp_compensation
  • Цель: достичь temp_target + temp_compensation

BOILING:
  • Реле включено (нагрев)
  • RGB LED выключен (или индикация partial_boil при удержании BTN1)
  • LED индикаторы выключены
  • Контроль времени кипения (от момента достижения 95°C)
  • partial_boil влияет на время кипения (×0.25)

ALARMING:
  • Реле выключено
  • RGB LED пульсирует
  • Buzzer: 30-секундная последовательность (10с вкл, 10с пауза, 10с вкл)
  • Любое нажатие кнопки → возврат в OFF

ERROR:
  • Реле выключено
  • RGB LED мигает красным (250 мс вкл/выкл)
  • Buzzer мигает синхронно с LED (250 мс вкл/выкл)
  • Причины: temp >= TEMP_MAX, temp < TEMP_MIN, застревание температуры, таймаут
  • Любое нажатие кнопки → возврат в OFF
═══════════════════════════════════════════════════════════════════════
РЕКОМЕНДУЕМЫЕ УЛУЧШЕНИЯ
═══════════════════════════════════════════════════════════════════════
🟢 НИЗКИЙ ПРИОРИТЕТ (код оптимизирован):
1. Калибровка NTC через EEPROM
   Сохранять коэффициенты калибровки для точной настройки
   под конкретный термистор
2. Добавление режима энергосбережения
   Отключение RGB LED после завершения нагрева
═══════════════════════════════════════════════════════════════════════
КОРОТКИЕ ИНСТРУКЦИИ ДЛЯ РАЗРАБОТЧИКА
═══════════════════════════════════════════════════════════════════════
КОМПИЛЯЦИЯ:
Microchip Studio:
  1. Project Properties → Toolchain → Symbols
  2. Добавить: F_CPU=8000000UL
  3. Optimization: -Os (optimize for size)
  4. Build → Rebuild Solution

УСТАНОВКА ФЬЮЗОВ (РЕКОМЕНДУЕТСЯ):
  avrdude -c usbasp -p t44 -U lfuse:w:0xE2:m -U hfuse:w:0xDD:m -U efuse:w:0xFF:m
  
  Расшифровка:
  - LFUSE 0xE2: внутренний RC 8MHz, без делителя, startup 65ms
  - HFUSE 0xDD: сохранить EEPROM при стирании, BOD 2.7V
  - EFUSE 0xFF: самопрограммирование отключено

ПРОШИВКА:
1. Подключить USBasp к ISP разъёму J3
2. Установить фьюзы (один раз)
3. Прошить firmware:
   avrdude -c usbasp -p t44 -U flash:w:main.hex:i

⚠️ ВАЖНО: При программировании временно отключите:
  - LED_R (PB2 используется как SCK)
  - BUZZER (PA5 используется как MOSI)
  - LED_B (PA6 используется как MISO)
  Или используйте джамперы для отключения R2, R4, R9

КАЛИБРОВКА NTC:
1. Измерить реальную температуру воды термометром
2. Прочитать значение ADC (можно вывести через LED индикацию)
3. Подобрать коэффициенты в формуле read_temp_raw():
   if (mid > 558) return (18291 - mid * 26);
   else return (13820 - mid * 18);
4. Проверить точность в диапазоне 20-100°C

ДЕБАГ БЕЗ UART:
1. RGB LED для индикации состояний (цвет = состояние)
2. LED индикаторы для показа числовых значений (двоичный код)
3. Buzzer для звуковых кодов ошибок (количество писков)
4. EEPROM для логирования критических событий
═══════════════════════════════════════════════════════════════════════
ИЗВЕСТНЫЕ ОГРАНИЧЕНИЯ
═══════════════════════════════════════════════════════════════════════
1. Flash память ATtiny44A: 4096 байт
   - Текущий код: оптимизирован под -Os
   - Запас: зависит от компиляции (~100-200 байт)
   
2. RAM (SRAM): 256 байт
   - Глобальные переменные: ~40 байт
   - Стек: ~20 байт
   - Буферы: массив arrTimeEff[8] = 8 байт
   - Запас: достаточно для текущей логики

3. EEPROM: 256 байт
   - Адрес 0x00: preset_idx (1 байт)
   - Адрес 0x01: effectMode (1 байт)
   - Свободно: 254 байта (для будущих функций)

4. Ограничения ISP программирования:
   - Конфликт пинов с RGB LED и BUZZER
   - Рекомендуется программировать до пайки компонентов
   - Или использовать джамперы/выключатели
═══════════════════════════════════════════════════════════════════════
ФОРМУЛА РАСЧЁТА ТЕМПЕРАТУРЫ
═══════════════════════════════════════════════════════════════════════
Функция: read_temp_raw()

Чтение ADC:
  - REFS0: опорное напряжение VCC (5V)
  - Prescaler: /16 (ADPS2|ADPS1)
  - Канал: ADC1 (PA1)
  - Медианный фильтр из 3 последних измерений

Делитель NTC:
  VCC (5V) → R1 (47кОм) → ADC1 → NTC1 (50кОм) → GND
  
Формула преобразования ADC → температура (в сотых °C):
  if (ADC > 558)
    temp = 18291 - ADC * 26
  else
    temp = 13820 - ADC * 18

Примеры:
  ADC = 200 → 13820 - 3600 = 10220 → 102.2°C (кипяток)
  ADC = 400 → 13820 - 7200 = 6620 → 66.2°C (тёплая вода)
  ADC = 600 → 18291 - 15600 = 2691 → 26.9°C (комнатная температура)
  ADC = 800 → 18291 - 20800 = -2509 → ошибка (обрыв датчика)

Фильтрация:
  temp_now += (raw - temp_now) / 32  // Экспоненциальное сглаживание
  
Обнаружение изменения:
  if (|temp_now - last_stable| > 100)  // 1°C
    temp_last_change = system_millis
═══════════════════════════════════════════════════════════════════════
АЛГОРИТМ АДАПТИВНОЙ КОМПЕНСАЦИИ
═══════════════════════════════════════════════════════════════════════
Цель: точно выключить нагрев в момент достижения целевой температуры,
компенсируя инерцию нагрева (вода продолжает нагреваться после 
отключения реле из-за теплоёмкости ТЭНа).

Переменные:
  temp_compensation: корректировка температуры выключения (в сотых °C)
  rate: скорость нагрева (в сотых °C за 10 секунд)

Начальное значение: temp_compensation = -150 (-1.5°C)

Расчёт скорости нагрева:
  rate = (temp_now - last_calc) * 10000 / dt
  где dt - время в миллисекундах

Формулы компенсации:
  if (rate > 5000)         → ERROR (сухое кипячение >50°C/сек)
  if (rate >= 1300)        → temp_compensation = -1180 (-11.8°C)
  else if (rate > 720)     → temp_compensation = 120 - rate
  else if (rate > 200)     → temp_compensation = 253796 / rate - 933
  else                     → temp_compensation = 350 (+3.5°C)

Условие выключения:
  if (temp_now >= temp_target + temp_compensation)
    enter_state(ALARMING)

Эмпирически подобрано для чайника 1.7л с ТЭНом 2000W.
═══════════════════════════════════════════════════════════════════════
РАСЧЁТ ВРЕМЕНИ КИПЕНИЯ
═══════════════════════════════════════════════════════════════════════
Цель: определить оптимальное время кипения в зависимости от мощности
нагрева (скорости роста температуры).

Алгоритм:
1. При достижении 95°C: boil_start = system_millis
2. Расчёт скорости нагрева: rate = (temp_now - last_calc) * 10000 / elapsed
3. Ограничения скорости: 272 <= rate <= 3000
4. Формула времени кипения:
   boil_time = 19082305 / rate + 5375  (в миллисекундах)
5. Для partial_boil: boil_time = boil_time / 4
6. Завершение: if (system_millis - boil_start > boil_time) → ALARMING

Примеры:
  rate = 3000 (макс) → boil_time = 6361 + 5375 = 11736 мс (~12 сек)
  rate = 1500 (сред) → boil_time = 12722 + 5375 = 18097 мс (~18 сек)
  rate = 272 (мин)   → boil_time = 70155 + 5375 = 75530 мс (~76 сек)

Базовое время без расчёта: 16000 мс (16 секунд)
═══════════════════════════════════════════════════════════════════════
КОНТАКТЫ И ПОДДЕРЖКА
═══════════════════════════════════════════════════════════════════════
⚠️ ВНИМАНИЕ: Реле коммутирует 220V AC - соблюдайте технику безопасности!
Изолируйте все высоковольтные контакты. Работу с 220V доверяйте только 
квалифицированным специалистам.

ПРЕДУПРЕЖДЕНИЕ О БЕЗОПАСНОСТИ:
- Минимальный зазор между 220V и 5V: 5 мм
- Используйте реле с изолированным корпусом
- Термистор должен быть изолирован от высоковольтных цепей
- Не эксплуатируйте устройство без защитного корпуса
- Регулярно проверяйте контакты реле на износ
═══════════════════════════════════════════════════════════════════════

